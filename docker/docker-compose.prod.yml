version: '3.9'

services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "no"]
    networks:
      - default

  backend:
    environment:
      APP_ENV: production
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    # In production you typically do not bind-mount source code
    volumes: []
    networks:
      - default
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.nextiwant-api.rule=Host(`api.nextiwant.com`)"
      - "traefik.http.routers.nextiwant-api.entrypoints=websecure"
      - "traefik.http.routers.nextiwant-api.tls=true"
      - "traefik.http.routers.nextiwant-api.tls.certresolver=le"
      - "traefik.http.routers.nextiwant-api.service=nextiwant-api"
      - "traefik.http.services.nextiwant-api.loadbalancer.server.port=8000"

  frontend:
    environment:
      APP_ENV: production
    build:
      context: ..
      dockerfile: docker/frontend.Dockerfile
    # No bind-mounts in production; use the built app inside the image
    volumes: []
    networks:
      - default
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.nextiwant.rule=Host(`nextiwant.com`)"
      - "traefik.http.routers.nextiwant.entrypoints=websecure"
      - "traefik.http.routers.nextiwant.tls=true"
      - "traefik.http.routers.nextiwant.tls.certresolver=le"
      - "traefik.http.routers.nextiwant.service=nextiwant"
      - "traefik.http.services.nextiwant.loadbalancer.server.port=3000"

networks:
  proxy:
    external: true
    name: proxy
